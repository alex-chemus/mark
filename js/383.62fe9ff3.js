"use strict";(self["webpackChunkmark"]=self["webpackChunkmark"]||[]).push([[383],{383:function(t,e,a){a.r(e),a.d(e,{default:function(){return Y}});var s=a(252),n=a(262),r=a(577),o=a(963),u=a(562),i=a(201),l=a(907),c=a(235),d=a(53),p=a(933);const h=({route:t})=>{const e=(0,n.iH)(null),a=async a=>{if(!a.value||!t.params.groupID)return;const{response:s,error:n}=await(0,c.ib)({path:"markMethods/attendance.getAttendanceListInfo",data:{groupID:t.params.groupID}});n?(console.log(n),p.h.dispatch("setError",n)):e.value=s.students},s=t=>{e.value&&(e.value=e.value.map((e=>e.userID===t?{...e,isPresent:!e.isPresent}:{...e})))};return{attendance:e,fetchAttendance:a,updateAttendance:s}};var v=h;const g=()=>{const t=async(t,e)=>{const a=t.map((t=>t.userID));if(!a.length)return;const{error:s}=await(0,c.ib)({path:"markMethods/attendance.markUserAttendance",data:{groupID:e,usersIDs:a}});s&&(console.log(s),p.h.dispatch("setError",s))},e=async(t,e)=>{const a=t.map((t=>t.userID));if(!a.length)return;const{error:s}=await(0,c.ib)({path:"markMethods/attendance.removeUserAttendance",data:{groupID:e,usersIDs:a}});s&&(console.log(s),p.h.dispatch("setError",s))},a=(0,n.iH)(0),s=async({attendance:s,groupID:n})=>{await t(s.filter((t=>t.isPresent)),n),await e(s.filter((t=>!t.isPresent)),n),a.value+=1};return{saveReport:s,saveCount:a}};var f=g;function D(t){for(var e="",a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",s=a.length,n=0;n<t;n++)e+=a.charAt(Math.floor(Math.random()*s));return e}const I=()=>{const t=(0,n.iH)(null),e=(0,n.iH)(0),a=(0,n.iH)(0),s=async(e,s)=>{if(p.h.getters.roles.includes("teacher"))p.h.state.userInfo?.id&&(s=[p.h.state.userInfo.id]);else if(!s||!s.length)return a.value+=1,"not selected";const{response:n,error:r}=await(0,c.ib)({path:"markMethods/attendance.createAttendanceReport",data:{groupID:e,hash:D(30)}});r?(console.log(r),p.h.dispatch("setError",r)):t.value=n},{saveReport:r}=f(),o=async({groupID:a,usersIDs:n,attendance:o})=>{await r({groupID:a,attendance:o});const u=await s(a,n);if(p.h.getters.roles.includes("teacher")&&p.h.state.userInfo?.id&&(n=[p.h.state.userInfo.id]),t.value&&!u){const{error:a}=await(0,c.ib)({path:"markMethods/attendance.sendAttendanceReport",data:{reportID:t.value,hash:D(30),usersIDs:n}});a?(console.log(a),p.h.dispatch(a)):e.value+=1}};return{createAndSendReport:o,createAndSaveCount:e,notSelectedCounter:a}};var m=I;const b=({router:t,route:e})=>{const a=(0,n.iH)(!1),s=()=>{if(!p.h.getters.roles||!p.h.state.userInfo)return;const e="head_student"===p.h.state.userInfo.institutionData.groupStatus,a="deputy_head_student"===p.h.state.userInfo.institutionData.groupStatus;if(e||a)return void(p.h.state.userInfo.additionalData.inGroups[0]?t.push({path:`/new-report/${p.h.state.userInfo.additionalData.inGroups[0]}`}):t.push({path:"/notfound"}));const s=p.h.getters.roles.includes("teacher");if(s)return void(p.h.state.userInfo.additionalData.inGroups.length?t.push({path:`/new-report/${p.h.state.userInfo.additionalData.inGroups[0]}`}):t.push({path:"/notfound"}));if(!p.h.state.institution)return;const n=p.h.getters.roles.includes("administrator_of_institution");n&&p.h.state.institution.groups[0]?t.push({path:`/new-report/${p.h.state.institution.groups[0]}`}):t.push({path:"/notfound"})},r=()=>{if(!p.h.getters.roles||!p.h.state.userInfo||!e.path.startsWith("/new-report"))return;if(!e.params.groupID)return console.log("push to starting route"),void s();const n="head_student"===p.h.state.userInfo.institutionData.groupStatus,r="deputy_head_student"===p.h.state.userInfo.institutionData.groupStatus;if(n||r){const t=p.h.state.userInfo.additionalData.inGroups[0]===+e.params.groupID;if(t)return void(a.value=!0);s()}const o=p.h.getters.roles.includes("teacher");if(o){const t=[...p.h.state.userInfo.additionalData.inGroups,...p.h.state.userInfo.additionalData.ownGroups].includes(+e.params.groupID);if(t)return void(a.value=!0);s()}if(!p.h.state.institution)return;const u=p.h.getters.roles.includes("administrator_of_institution");if(u){const t=p.h.state.institution.groups.includes(+e.params.groupID);if(t)return void(a.value=!0);s()}t.push({path:"/notfound"})},o=[()=>p.h.getters.roles,()=>p.h.state.userInfo,()=>p.h.state.institution,()=>e.params.groupID];return{isValid:a,validate:r,validationDeps:o}};var k=b;const S=t=>((0,s.dD)("data-v-28f66bf4"),t=t(),(0,s.Cn)(),t),w=u+"#tabler-layout-sidebar-right",_={key:0,class:"no-students"},y={key:1,class:"main --sidebar"},U={class:"sidebar --desktop"},C=S((()=>(0,s._)("div",{class:"separator"},null,-1))),A={key:0,class:"group-title"},H=S((()=>(0,s._)("svg",{width:"24",height:"24",viewBox:"0 0 24 24"},[(0,s._)("use",{href:w})],-1))),W=[H],M={key:0,class:"popup"},R=S((()=>(0,s._)("div",{class:"separator"},null,-1))),E={key:0,class:"nav"},G={class:"main-single"};var P=(0,s.aZ)({__name:"NewReport",setup(t){const e=(0,i.tv)(),a=(0,i.yj)(),u=(0,s.f3)("key"),{getters:p,state:h}=(0,l.oR)(u),{validate:g,validationDeps:D,isValid:I}=k({route:a,router:e});(0,s.wF)(g),(0,s.YP)(D,g),(0,s.wF)((()=>document.title="Создать отчет"));const{attendance:b,fetchAttendance:S,updateAttendance:w}=v({route:a});(0,s.bv)((()=>S(I))),(0,s.YP)([I,()=>a.params.groupID],(()=>S(I)));const H=(0,n.iH)(null),P=(0,n.iH)(null),q=(0,n.iH)(null);(0,s.YP)([I,()=>a.params.groupID],(()=>{const t=+a.params.groupID;a.params.groupID&&(H.value=p.getGroups(t),H.value&&(P.value=H.value.headStudentID,q.value=H.value.deputyHeadStudentID))}));const L=(0,n.iH)([]),Y=t=>{L.value.includes(t)?L.value=L.value.filter((e=>e!==t)):L.value.push(t)},{saveReport:Z,saveCount:x}=f(),N=()=>{I&&b.value&&Z({attendance:b.value,groupID:+a.params.groupID})},{createAndSendReport:F,createAndSaveCount:j,notSelectedCounter:z}=m(),T=()=>{I&&b.value&&(p.roles.includes("teacher")?F({groupID:+a.params.groupID,attendance:b.value}):F({groupID:+a.params.groupID,usersIDs:L.value,attendance:b.value}))},V=(0,n.iH)(!1),$=t=>{if("string"!==typeof t)return t===P.value?"Староста":t===q.value?"Зам. старосты":void 0},B=(0,s.Fl)((()=>H.value?Array.isArray(H.value.users.teachers)?H.value.users.teachers:Object.values(H.value.users.teachers):[]));return(t,e)=>((0,s.wg)(),(0,s.iD)(s.HY,null,[(0,s.Wm)((0,n.SU)(c.bZ),{text:"Учителя не выбраны!",observer:(0,n.SU)(z)},null,8,["observer"]),(0,s.Wm)((0,n.SU)(c.bZ),{text:"Отчет сохранен и отправлен!",observer:(0,n.SU)(j)},null,8,["observer"]),(0,s.Wm)((0,n.SU)(c.bZ),{text:"Посещаемость сохранена!",observer:(0,n.SU)(x)},null,8,["observer"]),(0,n.SU)(b)&&!(0,n.SU)(b).length?((0,s.wg)(),(0,s.iD)("div",_," В этой группе нет студентов ")):(0,n.SU)(b)&&H.value?((0,s.wg)(),(0,s.iD)("main",y,[(0,s._)("section",U,[(0,s.Wm)((0,n.SU)(d.ML),{teacherIDs:(0,n.SU)(B),selectedIDs:L.value,onSelect:Y},null,8,["teacherIDs","selectedIDs"]),C,(0,s._)("button",{onClick:N,class:"button"},"Отметить"),(0,s._)("button",{onClick:T,class:"button"},"Отправить отчет")]),(0,s._)("section",null,[H.value.groupName?((0,s.wg)(),(0,s.iD)("div",A,[(0,s._)("h3",null,(0,r.zw)(H.value.groupName),1),(0,s._)("button",{class:"mobile-sidebar-button",onClick:e[0]||(e[0]=t=>V.value=!V.value)},W),(0,s.Wm)(o.uT,{name:"mobile-sidebar-animation"},{default:(0,s.w5)((()=>[V.value?((0,s.wg)(),(0,s.iD)("section",M,[(0,s.Wm)((0,n.SU)(d.ML),{teacherIDs:(0,n.SU)(B),selectedIDs:L.value,onSelect:Y},null,8,["teacherIDs","selectedIDs"]),R,(0,s._)("button",{onClick:N,class:"button"},"Отметить"),(0,s._)("button",{onClick:T,class:"button"},"Отправить отчет")])):(0,s.kq)("",!0)])),_:1}),(0,s.Wm)(o.uT,{name:"mobile-backdrop-animation"},{default:(0,s.w5)((()=>[V.value?((0,s.wg)(),(0,s.iD)("div",{key:0,class:"backdrop",onClick:e[1]||(e[1]=t=>V.value=!V.value)})):(0,s.kq)("",!0)])),_:1})])):(0,s.kq)("",!0),(0,s.Wm)((0,n.SU)(d.LW),{"users-data":(0,n.SU)(b),onEdit:(0,n.SU)(w),"check-status":$},null,8,["users-data","onEdit"])])])):(0,n.SU)(b)?((0,s.wg)(),(0,s.iD)(s.HY,{key:2},[H.value?((0,s.wg)(),(0,s.iD)("nav",E,[(0,s._)("h1",null,(0,r.zw)(H.value.groupName),1)])):(0,s.kq)("",!0),(0,s._)("main",G,[(0,s.Wm)((0,n.SU)(d.LW),{"users-data":(0,n.SU)(b),onEdit:(0,n.SU)(w),"check-status":$},null,8,["users-data","onEdit"]),(0,s._)("button",{onClick:N,class:"button --mt"},"Отметить"),(0,s._)("button",{onClick:T,class:"button"},"Отправить отчет")])],64)):(0,s.kq)("",!0)],64))}}),q=a(744);const L=(0,q.Z)(P,[["__scopeId","data-v-28f66bf4"]]);var Y=L}}]);
//# sourceMappingURL=383.62fe9ff3.js.map